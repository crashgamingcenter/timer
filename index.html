<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ConsoleManager Pro v6.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .timer-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left-width: 10px; }
        .status-active { border-left-color: #10b981; }
        .status-paused { border-left-color: #f59e0b; }
        .status-finished { animation: emergency-flash 0.5s infinite alternate !important; border-left-color: #ffffff !important; }
        @keyframes emergency-flash { 
            0% { background-color: #0f172a !important; box-shadow: 0 0 0px rgba(239, 68, 68, 0); }
            100% { background-color: #dc2626 !important; box-shadow: 0 0 40px rgba(239, 68, 68, 0.7); }
        }
        .no-select { user-select: none; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
        
        /* Notificaci√≥n de PIN */
        #pin-notify { transform: translateY(-100px); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #pin-notify.show { transform: translateY(20px); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans no-select">

    <!-- Notificaci√≥n Flotante -->
    <div id="pin-notify" class="fixed top-0 left-0 right-0 flex justify-center z-[100] pointer-events-none">
        <div class="bg-emerald-600 text-white px-6 py-3 rounded-2xl shadow-2xl font-black text-xs uppercase tracking-widest flex items-center gap-3">
            <span class="text-xl">üîê</span> PIN ACTUALIZADO CORRECTAMENTE
        </div>
    </div>

    <header class="bg-slate-900/80 backdrop-blur-md p-4 sticky top-0 z-50 border-b border-white/5 flex justify-between items-center shadow-xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black shadow-lg text-white">CP</div>
            <div>
                <h2 class="text-sm font-black tracking-tighter leading-none uppercase italic text-white leading-none">Console<span class="text-blue-500">Pro v6.2</span></h2>
                <p id="cajero-tag" class="text-[9px] text-slate-500 font-bold uppercase mt-1 tracking-widest italic leading-none">---</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="ui.checkAuth('caja')" class="px-4 py-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded-xl text-[10px] font-black hover:bg-emerald-500/20 transition-all uppercase">üíµ Caja</button>
            <button onclick="ui.checkAuth('admin')" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-xl border border-white/5 transition-all">‚öôÔ∏è</button>
        </div>
    </header>

    <main id="consoles-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-32"></main>

    <button onclick="app.addConsole()" class="fixed bottom-8 right-8 w-20 h-20 bg-blue-600 hover:bg-blue-500 rounded-[2rem] shadow-2xl flex items-center justify-center text-3xl z-40 border-t border-white/20 text-white shadow-blue-500/40">‚ûï</button>

    <div id="modal-overlay" class="fixed inset-0 bg-black/95 backdrop-blur-sm z- hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-slate-900 w-full max-w-lg rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden"></div>
    </div>

    <audio id="alarm-sound" loop preload="auto"></audio>

    <script>
        const app = {
            state: {
                consoles: [],
                config: {
                    rateMin: 1.0, rate15: 15, rate30: 25, rate60: 45, rateExtra: 10,
                    activeCajero: 'Admin',
                    alarmData: 'https://assets.mixkit.co',
                    adminPass: '1234'
                },
                cajeros: ['Admin'],
                historial: []
            },

            init() {
                this.load();
                this.startTicker();
                this.syncAlarm();
                ui.render();
            },

            load() {
                try {
                    const saved = localStorage.getItem('cp_v6_final');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.state = Object.assign({}, this.state, parsed);
                    }
                    this.state.consoles.forEach(c => {
                        if (c.status === 'active' && c.endTime) {
                            c.timeLeft = Math.max(0, Math.round((c.endTime - Date.now()) / 1000));
                            if (c.timeLeft === 0) c.status = 'finished';
                        }
                        this.calculateTotal(c);
                    });
                } catch (e) { console.error(e); }
            },

            save() { localStorage.setItem('cp_v6_final', JSON.stringify(this.state)); },

            syncAlarm() {
                const aud = document.getElementById('alarm-sound');
                if (aud) { aud.src = this.state.config.alarmData; aud.load(); }
            },

            calculateTotal(c) {
                const minutes = Math.ceil(c.timeLeft / 60);
                const cfg = this.state.config;
                let tPrice = (minutes >= 60) ? (minutes / 60) * cfg.rate60 : (minutes >= 30) ? cfg.rate30 : (minutes >= 15) ? cfg.rate15 : minutes * cfg.rateMin;
                c.total = tPrice + ((c.extras || 0) * cfg.rateExtra);
                return c.total;
            },

            startTicker() {
                setInterval(() => {
                    let refresh = false, alarm = false;
                    this.state.consoles.forEach(c => {
                        if (c.status === 'active') {
                            c.timeLeft--;
                            if (c.timeLeft <= 0) { c.timeLeft = 0; c.status = 'finished'; alarm = true; refresh = true; }
                        }
                    });
                    if (refresh) ui.render(); else ui.updateUIOnly();
                    if (alarm) ui.playAlarm();
                }, 1000);
            },

            addConsole() {
                this.state.consoles.push({ id: Date.now(), name: `CONSOLA ${this.state.consoles.length + 1}`, timeLeft: 0, extras: 0, status: 'idle', total: 0, endTime: null });
                this.save(); ui.render();
            }
        };

        const ui = {
            checkAuth(target) {
                const pass = prompt("üîê Ingrese el PIN Maestro:");
                if (pass === app.state.config.adminPass) {
                    target === 'caja' ? this.showCaja() : this.toggleAdmin();
                } else if (pass !== null) {
                    alert("‚ùå PIN Incorrecto");
                }
            },

            render() {
                const grid = document.getElementById('consoles-grid');
                if(!grid) return;
                grid.innerHTML = app.state.consoles.map(c => `
                    <div class="timer-card bg-slate-900 p-6 rounded-[2.5rem] border border-white/5 status-${c.status} shadow-2xl relative">
                        <div class="flex justify-between items-center mb-6">
                            <input onchange="ui.rename(${c.id}, this.value)" value="${c.name}" class="bg-transparent font-black italic uppercase outline-none focus:text-blue-400 w-2/3 text-white">
                            <button onclick="ui.deleteConsole(${c.id})" class="w-8 h-8 flex items-center justify-center bg-red-900/20 text-red-500 rounded-full hover:bg-red-500 hover:text-white text-xs transition-all">‚úï</button>
                        </div>
                        <div class="bg-black/40 rounded-[2rem] py-8 text-center border border-white/5 shadow-inner mb-6">
                            <div id="timer-${c.id}" class="text-6xl font-mono font-black tracking-tighter ${c.status === 'finished' ? 'text-white' : 'text-blue-400'}">
                                ${this.formatTime(c.timeLeft)}
                            </div>
                            <div class="text-[10px] font-black tracking-[0.4em] uppercase text-emerald-500 mt-2 italic leading-none">$${c.total.toFixed(2)} TOTAL</div>
                        </div>
                        <div class="bg-slate-800/40 rounded-2xl p-4 mb-6 flex justify-between items-center border border-white/5">
                            <div class="text-left leading-none"><p class="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">Mandos</p><p class="text-[10px] font-bold text-blue-400">+$${((c.extras || 0) * app.state.config.rateExtra).toFixed(2)}</p></div>
                            <div class="flex items-center gap-4">
                                <button onclick="ui.updateExtras(${c.id}, -1)" class="w-8 h-8 bg-slate-700 rounded-lg font-black hover:bg-slate-600 text-white">-</button>
                                <span class="font-black text-lg w-4 text-center text-white">${c.extras || 0}</span>
                                <button onclick="ui.updateExtras(${c.id}, 1)" class="w-8 h-8 bg-slate-700 rounded-lg font-black hover:bg-slate-600 text-white">+</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            ${[15, 30, 60].map(m => `<button onclick="ui.addTime(${c.id}, ${m})" class="bg-slate-800 py-3 rounded-xl text-[10px] font-black text-white hover:bg-blue-600 uppercase border border-white/5">+${m}</button>`).join('')}
                            <button onclick="ui.promptCustomTime(${c.id})" class="bg-blue-600/20 text-blue-400 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white border border-blue-500/20 shadow-inner leading-none text-center">‚úé</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="ui.togglePause(${c.id})" class="flex-1 py-4 bg-slate-800 rounded-2xl text-[10px] font-black uppercase text-white">${c.status === 'paused' ? '‚ñ∂' : '‚è∏'}</button>
                            <button onclick="ui.showCheckout(${c.id})" class="flex-1 py-4 bg-emerald-600 rounded-2xl text-[10px] font-black uppercase text-white shadow-lg shadow-emerald-500/30">üõë Cobrar</button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('cajero-tag').innerText = `OPERADOR: ${app.state.config.activeCajero}`;
            },

            formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; },
            updateUIOnly() { app.state.consoles.forEach(c => { const el = document.getElementById(`timer-${c.id}`); if (el) el.innerText = this.formatTime(c.timeLeft); }); },
            
            addTime(id, mins) {
                const c = app.state.consoles.find(x => x.id === id);
                if(c) { c.timeLeft += (mins * 60); c.status = 'active'; c.endTime = Date.now() + (c.timeLeft * 1000); app.calculateTotal(c); app.save(); this.render(); }
            },

            promptCustomTime(id) {
                const mins = prompt("Minutos a a√±adir:");
                if(mins && !isNaN(mins)) this.addTime(id, parseInt(mins));
            },

            updateExtras(id, delta) {
                const c = app.state.consoles.find(x => x.id === id);
                if(c) { c.extras = Math.max(0, (c.extras || 0) + delta); app.calculateTotal(c); app.save(); this.render(); }
            },

            showCheckout(id) {
                const c = app.state.consoles.find(x => x.id === id);
                if(!c) return;
                this.openModal(`
                    <div class="p-8">
                        <h2 class="text-3xl font-black italic uppercase tracking-tighter mb-8 text-center text-white leading-none">Resumen de Cobro</h2>
                        <div class="space-y-4 mb-10 bg-black/40 p-6 rounded-[2rem] border border-white/10 shadow-inner">
                            <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest"><span>Servicio:</span> <span>$${(c.total - (c.extras * app.state.config.rateExtra)).toFixed(2)}</span></div>
                            <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest"><span>Mandos:</span> <span>$${(c.extras * app.state.config.rateExtra).toFixed(2)}</span></div>
                            <div class="flex justify-between text-4xl font-black text-emerald-400 border-t border-white/10 pt-4 mt-4 uppercase italic leading-none"><span>TOTAL:</span> <span>$${c.total.toFixed(2)}</span></div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="ui.closeModal()" class="flex-1 py-5 bg-slate-800 rounded-2xl font-black text-[10px] uppercase text-white">Cerrar</button>
                            <button onclick="ui.processPayment(${c.id})" class="flex-1 py-5 bg-emerald-600 rounded-2xl font-black text-[10px] uppercase text-white shadow-xl shadow-emerald-500/20">Pago Recibido</button>
                        </div>
                    </div>
                `);
            },

            processPayment(id) {
                const idx = app.state.consoles.findIndex(x => x.id === id);
                const c = app.state.consoles[idx];
                app.state.historial.push({ fecha: new Date().toLocaleString(), cajero: app.state.config.activeCajero, consola: c.name, total: c.total });
                c.timeLeft = 0; c.extras = 0; c.status = 'idle'; c.total = 0; c.endTime = null;
                this.stopAlarm(); app.save(); this.closeModal(); this.render();
            },

            toggleAdmin() {
                const cfg = app.state.config;
                this.openModal(`
                    <div class="p-8 custom-scroll overflow-y-auto max-h-[85vh]">
                        <h2 class="text-2xl font-black italic uppercase mb-8 text-white tracking-tighter leading-none">Panel de Control</h2>
                        
                        <div class="mb-8 p-4 bg-red-600/10 rounded-2xl border border-red-500/20">
                            <label class="text-[9px] font-black text-red-400 uppercase block mb-2 tracking-widest italic">PIN Maestro</label>
                            <input id="cfg-pass" type="password" value="${cfg.adminPass}" class="w-full bg-slate-800 p-4 rounded-xl border border-white/5 text-center text-white font-black tracking-widest outline-none focus:border-red-500 transition-colors">
                        </div>

                        <div class="mb-8 p-6 bg-blue-600/10 rounded-[2rem] border border-blue-500/20 text-center">
                            <p class="text-[9px] font-black text-blue-400 uppercase mb-4 tracking-widest italic leading-none">Alerta de Audio</p>
                            <input type="file" id="audio-file" accept="audio/mp3" onchange="ui.uploadAudio(this)" class="hidden">
                            <label for="audio-file" class="block w-full py-4 bg-blue-600 rounded-2xl text-[10px] font-black cursor-pointer uppercase shadow-lg text-white mb-4">Cambiar MP3</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="ui.playAlarm()" class="bg-emerald-600/20 py-3 rounded-xl text-[10px] font-black text-emerald-400 border border-emerald-500/20 uppercase">‚ñ∂ Probar</button>
                                <button onclick="ui.stopAlarm()" class="bg-red-600/20 py-3 rounded-xl text-[10px] font-black text-red-400 border border-red-500/20 uppercase">‚èπ Parar</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <div class="space-y-1 text-center"><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Minuto $</label><input id="p-min" type="number" step="0.1" value="${cfg.rateMin}" class="w-full bg-slate-800 p-4 rounded-xl border border-white/5 text-center text-white font-black"></div>
                            <div class="space-y-1 text-center"><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Mando $</label><input id="p-ext" type="number" value="${cfg.rateExtra}" class="w-full bg-slate-800 p-4 rounded-xl border border-white/5 text-center text-white font-black"></div>
                            <div class="space-y-1 text-center"><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">30 Min $</label><input id="p-30" type="number" value="${cfg.rate30}" class="w-full bg-slate-800 p-4 rounded-xl border border-white/5 text-center text-white font-black"></div>
                            <div class="space-y-1 text-center"><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">60 Min $</label><input id="p-60" type="number" value="${cfg.rate60}" class="w-full bg-slate-800 p-4 rounded-xl border border-white/5 text-center text-white font-black"></div>
                        </div>

                        <div class="mb-8 p-4 bg-black/20 rounded-2xl border border-white/5 shadow-inner">
                            <label class="text-[9px] font-black text-slate-500 uppercase block mb-2 tracking-widest italic leading-none">Operador</label>
                            <div class="flex gap-2">
                                <select id="sel-caj" class="flex-1 bg-slate-800 p-4 rounded-xl border border-white/5 text-xs text-white outline-none">
                                    ${app.state.cajeros.map(c => `<option value="${c}" ${c === cfg.activeCajero ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                                <input id="new-caj" placeholder="+" class="w-16 bg-slate-800 p-4 rounded-xl border border-white/5 text-center text-white uppercase text-[10px]">
                                <button onclick="ui.addCajero()" class="bg-blue-600 px-4 rounded-xl font-black text-white shadow-lg shadow-blue-500/20">+</button>
                            </div>
                        </div>
                        <button onclick="ui.saveAdmin()" class="w-full py-5 bg-blue-600 rounded-2xl font-black text-xs uppercase tracking-widest text-white shadow-xl shadow-blue-500/20">Guardar Todo</button>
                    </div>
                `);
            },

            saveAdmin() {
                const oldPass = app.state.config.adminPass;
                const newPass = document.getElementById('cfg-pass').value;
                const cfg = app.state.config;
                
                cfg.adminPass = newPass;
                cfg.activeCajero = document.getElementById('sel-caj').value;
                cfg.rateMin = parseFloat(document.getElementById('p-min').value) || 0;
                cfg.rateExtra = parseFloat(document.getElementById('p-ext').value) || 0;
                cfg.rate30 = parseFloat(document.getElementById('p-30').value) || 0;
                cfg.rate60 = parseFloat(document.getElementById('p-60').value) || 0;
                
                app.state.consoles.forEach(c => app.calculateTotal(c));
                app.save();
                
                // Mostrar aviso si el PIN cambi√≥
                if (oldPass !== newPass) {
                    const notify = document.getElementById('pin-notify');
                    notify.classList.add('show');
                    setTimeout(() => notify.classList.remove('show'), 3000);
                }

                this.closeModal();
                this.render();
            },

            showCaja() {
                const total = app.state.historial.reduce((acc, curr) => acc + curr.total, 0);
                this.openModal(`
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-4">
                            <h2 class="text-2xl font-black italic uppercase leading-none text-white tracking-tighter">Corte Diario</h2>
                            <div class="text-emerald-400 font-black text-3xl italic tracking-tighter leading-none">$${total.toFixed(2)}</div>
                        </div>
                        <div class="max-h-80 overflow-y-auto space-y-2 mb-8 custom-scroll pr-1">
                            ${app.state.historial.map(h => `
                                <div class="bg-black/30 p-4 rounded-2xl border border-white/5 flex justify-between items-center mr-2 shadow-inner">
                                    <div class="text-left leading-none"><p class="text-[8px] font-bold text-slate-600 mb-1 uppercase tracking-widest leading-none">${h.fecha}</p>
                                    <p class="text-xs font-black uppercase text-blue-400 italic leading-none">${h.consola} <span class="text-slate-600 font-bold ml-1">// ${h.cajero}</span></p></div>
                                    <div class="font-black text-emerald-500 text-lg">$${h.total.toFixed(2)}</div>
                                </div>
                            `).reverse().join('') || '<p class="text-center py-10 text-slate-700 font-black italic uppercase tracking-widest opacity-50">Sin registros</p>'}
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="ui.exportData()" class="bg-slate-800 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest text-white shadow-inner border border-white/5">JSON</button>
                                <button onclick="ui.clearCaja()" class="bg-red-900/20 text-red-500 border border-red-500/20 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest active:bg-red-600">Limpiar</button>
                            </div>
                            <button onclick="ui.closeModal()" class="w-full bg-slate-700/40 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest border border-white/5 text-white">Regresar</button>
                        </div>
                    </div>
                `);
            },

            addCajero() {
                const i = document.getElementById('new-caj'); const n = i.value.trim();
                if (n && !app.state.cajeros.includes(n)) { app.state.cajeros.push(n); app.save(); this.toggleAdmin(); }
            },

            uploadAudio(input) {
                if (input.files) {
                    const r = new FileReader();
                    r.onload = (e) => { app.state.config.alarmData = e.target.result; app.syncAlarm(); alert("‚úÖ Audio cargado!"); };
                    r.readAsDataURL(input.files);
                }
            },

            clearCaja() { if(confirm('¬øReiniciar caja?')) { app.state.historial = []; app.save(); this.closeModal(); } },
            exportData() {
                const b = new Blob([JSON.stringify(app.state.historial, null, 2)], {type: 'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `corte_caja.json`; a.click();
            },
            togglePause(id) {
                const c = app.state.consoles.find(x => x.id === id);
                if (c.status === 'active') { c.status = 'paused'; c.endTime = null; }
                else if (c.status === 'paused') { c.status = 'active'; c.endTime = Date.now() + (c.timeLeft * 1000); }
                app.save(); this.render();
            },
            deleteConsole(id) { if(confirm('¬øBorrar consola?')) { app.state.consoles = app.state.consoles.filter(c => c.id !== id); app.save(); this.render(); } },
            rename(id, n) { const c = app.state.consoles.find(x => x.id === id); if(c) c.name = n; app.save(); },
            openModal(html) { document.getElementById('modal-content').innerHTML = html; document.getElementById('modal-overlay').classList.remove('hidden'); },
            closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); this.stopAlarm(); },
            playAlarm() { const a = document.getElementById('alarm-sound'); if(a.paused) a.play().catch(e => console.warn("Interacci√≥n requerida")); },
            stopAlarm() { const a = document.getElementById('alarm-sound'); a.pause(); a.currentTime = 0; }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
